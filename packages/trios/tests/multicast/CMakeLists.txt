INCLUDE(TribitsPackageMacros)
INCLUDE(TribitsAddOptionAndDefine)
INCLUDE(TribitsAddExecutable)
INCLUDE(TribitsAddExecutableAndTest)
INCLUDE(TribitsAddTest)
INCLUDE(TriosProcessXDR)

############# Special exception for rpcgen extra commas in enum ##########
IF (CMAKE_COMPILER_IS_GNUCXX)
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fpermissive")
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -isystem ${CMAKE_CURRENT_BINARY_DIR}")
  SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -isystem ${CMAKE_CURRENT_BINARY_DIR}")
ENDIF (CMAKE_COMPILER_IS_GNUCXX)

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})


# We want the binary directory to be a system directory because it contains
# code generated by rpcgen, may have many warnings.
#INCLUDE_DIRECTORIES(SYSTEM ${CMAKE_CURRENT_BINARY_DIR})

# Generate the XDR header and source file for the service arguments
TriosProcessXDR(${CMAKE_CURRENT_SOURCE_DIR}/multicast_service_args.x)



TRIBITS_ADD_EXECUTABLE(
  MulticastTest
  SOURCES multicast_service_args.c multicast_server.cpp multicast_test.cpp multicast_client.cpp multicast_buffer_util.cpp
  DEPLIBS ${DEPLIBS}
  NOEXEPREFIX
)

SET(EXTRA_TEST_ARGS "")

# Gemini network transport takes a few seconds to initialize
IF (${PACKAGE_NAME}_ENABLE_Gemini)
  APPEND_SET(EXTRA_TEST_ARGS "--delay=3")
ENDIF()


SET(TESTNAMES
   empty-request-sync
   empty-request-async
   get-sync
   get-async
   put-sync
   put-async)


foreach (testname ${TESTNAMES})

  SET(DEFAULT_ARGS "--io-method=${testname} ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --result-file=${testname}-result.out ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --result-file-mode=a ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --num-trials=5 ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --num-reqs=10 ")

  TRIBITS_ADD_TEST(
    MulticastTest
    NOEXEPREFIX
    NAME MulticastTest_${testname}
    ARGS "${DEFAULT_ARGS} ${EXTRA_TEST_ARGS}"
    COMM serial mpi
    NUM_MPI_PROCS 3)
endforeach()
