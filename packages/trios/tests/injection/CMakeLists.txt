
# @HEADER
#  ************************************************************************
#
#                    Trios: Trilinos I/O Support
#                  Copyright 2011 Sandia Corporation
#
#  Under the terms of Contract DE-AC04-94AL85000 with Sandia Corporation,
#  the U.S. Government retains certain rights in this software.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions are
#  met:
#
#  1. Redistributions of source code must retain the above copyright
#  notice, this list of conditions and the following disclaimer.
#
#  2. Redistributions in binary form must reproduce the above copyright
#  notice, this list of conditions and the following disclaimer in the
#  documentation and/or other materials provided with the distribution.
#
#  3. Neither the name of the Corporation nor the names of the
#  contributors may be used to endorse or promote products derived from
#  this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY SANDIA CORPORATION "AS IS" AND ANY
#  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
#  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
#  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL SANDIA CORPORATION OR THE
#  CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
#  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
#  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
#  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
#  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
#  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
#  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# Questions? Contact Ron A. Oldfield (raoldfi@sandia.gov)
#
#  *************************************************************************
# @HEADER


INCLUDE(TribitsPackageMacros)
INCLUDE(TribitsAddOptionAndDefine)
INCLUDE(TribitsAddExecutable)
INCLUDE(TribitsAddExecutableAndTest)
INCLUDE(TribitsAddTest)
INCLUDE(TriosProcessXDR)

############# Special exception for rpcgen extra commas in enum ##########
IF (CMAKE_COMPILER_IS_GNUCXX)
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fpermissive")
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -isystem ${CMAKE_CURRENT_BINARY_DIR}")
  SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -isystem ${CMAKE_CURRENT_BINARY_DIR}")
ENDIF (CMAKE_COMPILER_IS_GNUCXX)

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})


# We want the binary directory to be a system directory because it contains
# code generated by rpcgen, may have many warnings.
#INCLUDE_DIRECTORIES(SYSTEM ${CMAKE_CURRENT_BINARY_DIR})

# Generate the XDR header and source file for the service arguments
TriosProcessXDR(${CMAKE_CURRENT_SOURCE_DIR}/injection_service_args.x)



TRIBITS_ADD_EXECUTABLE(
  InjectionTest
  SOURCES injection_service_args.c injection_server.cpp injection_test.cpp injection_client.cpp
  DEPLIBS ${DEPLIBS}
  NOEXEPREFIX
)

SET(EXTRA_TEST_ARGS "")

# Gemini network transport takes a few seconds to initialize
IF (${PACKAGE_NAME}_ENABLE_Gemini)
  APPEND_SET(EXTRA_TEST_ARGS "--delay=3")
ENDIF()


SET(TESTNAMES
   empty-request-sync
   empty-request-async)


foreach (testname ${TESTNAMES})

  SET(DEFAULT_ARGS "--io-method=${testname} ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --result-file=${testname}-result.out ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --result-file-mode=a ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --num-trials=5 ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --num-reqs=10 ")

  TRIBITS_ADD_TEST(
    InjectionTest
    NOEXEPREFIX
    NAME InjectionTest_${testname}
    ARGS "${DEFAULT_ARGS} ${EXTRA_TEST_ARGS}"
    COMM serial mpi
    NUM_MPI_PROCS 2)
endforeach()
